# docker build -t torrent_service . -f Dockerfile_torrapi
FROM python:3.10

LABEL Author="Mikael"

# Install curl for HEALTHCHECK
RUN apt-get update && apt-get install -y --no-install-recommends curl && rm -rf /var/lib/apt/lists/*

RUN mkdir /app
WORKDIR /app

# Runtime defaults (override via environment/compose)
ENV TORR_API_PORT=9092
ENV TORR_API_PATH=/torr-api

# Copy application sources
COPY torrent_api/ ./
COPY utils.py ./

# Install Python dependencies
RUN pip install --no-cache-dir -r requirements.txt

# Service port
EXPOSE 9092

# Container healthcheck using the Falcon app's health endpoint
HEALTHCHECK --interval=30s --timeout=5s --retries=3 CMD sh -c 'BASE="${TORR_API_PATH:-/torr-api}"; BASE="${BASE#/}"; BASE="${BASE%/}"; curl -fsS "http://127.0.0.1:${TORR_API_PORT:-9092}/$BASE/health" || exit 1'

# Production entrypoint: Gunicorn serving wsgi:app
ENTRYPOINT ["sh","-c","exec gunicorn -c gunicorn.conf.py --bind 0.0.0.0:${TORR_API_PORT:-9092} wsgi:app"]
